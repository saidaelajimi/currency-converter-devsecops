name:  Quality Gates

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  backend-quality:
    name:  Backend Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name:  Checkout code
        uses: actions/checkout@v4
      
      - name:  Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name:  Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pytest pytest-cov pylint flake8 black isort bandit safety
      
      - name:  Run Linting (flake8)
        continue-on-error: true
        run: |
          cd backend
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      
      - name:  Check Code Formatting (black)
        continue-on-error: true
        run: |
          cd backend
          black --check --diff .
      
      - name:  Check Import Order (isort)
        continue-on-error: true
        run: |
          cd backend
          isort --check-only --diff .
      
      - name:  Security Check (bandit)
        continue-on-error: true
        run: |
          cd backend
          bandit -r . -f json -o bandit-report.json || true
          bandit -r . --severity-level medium
      
      - name:  Run Tests with Coverage
        run: |
          cd backend
          pytest --cov=. --cov-report=xml --cov-report=html --cov-report=term-missing -v
      
      - name:  Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./backend/coverage.xml
          flags: backend
          name: backend-coverage
          fail_ci_if_error: false
      
      - name:  Coverage Comment
        if: github.event_name == 'pull_request'
        uses: py-cov-action/python-coverage-comment-action@v3
        with:
          GITHUB_TOKEN: ${{ github.token }}
          MINIMUM_GREEN: 80
          MINIMUM_ORANGE: 60

  frontend-quality:
    name:  Frontend Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name:  Checkout code
        uses: actions/checkout@v4
      
      - name:  Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name:  Install dependencies
        run: |
          cd frontend
          npm ci
      
      - name:  Run ESLint
        continue-on-error: true
        run: |
          cd frontend
          npm run lint || true
      
      - name:  Check Code Formatting (Prettier)
        continue-on-error: true
        run: |
          cd frontend
          npx prettier --check "src/**/*.{js,jsx,ts,tsx,json,css,md}"
      
      - name:  Type Check (if TypeScript)
        continue-on-error: true
        run: |
          cd frontend
          if [ -f "tsconfig.json" ]; then
            npm run type-check || npx tsc --noEmit || true
          else
            echo "No TypeScript configuration found, skipping type check"
          fi
      
      - name:  Run Tests with Coverage
        run: |
          cd frontend
          npm test -- --coverage --watchAll=false || true
      
      - name:  Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./frontend/coverage/coverage-final.json
          flags: frontend
          name: frontend-coverage
          fail_ci_if_error: false
      
      - name: ðŸ—ï¸ Build Check
        run: |
          cd frontend
          npm run build

  code-metrics:
    name:  Code Metrics & Complexity
    runs-on: ubuntu-latest
    
    steps:
      - name:  Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name:  Run Code Climate Analysis
        uses: paambaati/codeclimate-action@v5.0.0
        continue-on-error: true
        env:
          CC_TEST_REPORTER_ID: ${{ secrets.CC_TEST_REPORTER_ID }}
        with:
          coverageCommand: echo "Coverage already generated"
      
      - name:  SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.organization=${{ github.repository_owner }}
            -Dsonar.projectKey=${{ github.repository_owner }}_${{ github.event.repository.name }}

  quality-summary:
    name:  Quality Gate Summary
    runs-on: ubuntu-latest
    needs: [backend-quality, frontend-quality, code-metrics]
    if: always()
    
    steps:
      - name:  Generate Quality Report
        run: |
          echo "#  Quality Gates Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Status" >> $GITHUB_STEP_SUMMARY
          echo "*  Backend Quality: **${{ needs.backend-quality.result }}**" >> $GITHUB_STEP_SUMMARY
          echo "*  Frontend Quality: **${{ needs.frontend-quality.result }}**" >> $GITHUB_STEP_SUMMARY
          echo "*  Code Metrics: **${{ needs.code-metrics.result }}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Quality Gate Decision
          BACKEND_STATUS="${{ needs.backend-quality.result }}"
          FRONTEND_STATUS="${{ needs.frontend-quality.result }}"
          
          if [ "$BACKEND_STATUS" == "success" ] && [ "$FRONTEND_STATUS" == "success" ]; then
            echo "## âœ… Quality Gates: PASSED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All quality checks passed. Code is ready for deployment." >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Quality Gates: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Issues Found:" >> $GITHUB_STEP_SUMMARY
            
            if [ "$BACKEND_STATUS" != "success" ]; then
              echo "* Backend quality checks failed" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ "$FRONTEND_STATUS" != "success" ]; then
              echo "* Frontend quality checks failed" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please fix the issues before deploying." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi