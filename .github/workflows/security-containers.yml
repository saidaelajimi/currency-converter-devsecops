name:  Container Security Scanning

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]

jobs:
  scan-backend:
    name:  Scan Backend
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    
    steps:
      - name:  Checkout
        uses: actions/checkout@v4
      
      - name:  Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name:  Build Backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: false
          load: true
          tags: currency-backend:scan
      
      - name:  Trivy Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: currency-backend:scan
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

  scan-frontend:
    name:  Scan Frontend
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    
    steps:
      - name:  Checkout
        uses: actions/checkout@v4
      
      - name:  Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name:  Build Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: false
          load: true
          tags: currency-frontend:scan
          build-args: VITE_API_URL=http://localhost:5000
      
      - name: Trivy Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: currency-frontend:scan
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [scan-backend, scan-frontend]
    if: always()
    
    steps:
      - name: Results
        run: |
          echo " Backend: ${{ needs.scan-backend.result }}"
          echo " Frontend: ${{ needs.scan-frontend.result }}"